import os
import asyncio
import nest_asyncio
import json
import asyncpg
import time
import datetime
import pytz
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, CallbackQueryHandler, filters, ContextTypes
from openai import AsyncOpenAI

# ‚úÖ –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª—É
nest_asyncio.apply()

# ‚úÖ –ß–∞—Å–æ–≤–∏–π –ø–æ—è—Å –ö–∏—î–≤–∞
TZ_KYIV = pytz.timezone("Europe/Kiev")

# ‚úÖ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è API
client = AsyncOpenAI(api_key=os.getenv("OPENAI_API_KEY"))
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
DATABASE_URL = os.getenv("DATABASE_URL")

# ‚úÖ ID –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞
ADMINS = {479486294}

# ‚úÖ –¢–µ—Ä–º—ñ–Ω –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∫–µ—à—É (24 –≥–æ–¥–∏–Ω–∏)
CACHE_EXPIRATION_TIME = 24 * 60 * 60  # 86400 —Å–µ–∫—É–Ω–¥

# ‚úÖ –ß–∞—Å –æ—á–∏—â–µ–Ω–Ω—è –∫–µ—à—É (03:00 GMT+3)
CACHE_CLEANUP_HOUR = 3  

# ‚úÖ –§—É–Ω–∫—Ü—ñ—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
async def connect_to_db():
    try:
        return await asyncpg.create_pool(DATABASE_URL)
    except Exception as e:
        print(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö: {e}")
        return None

# ‚úÖ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
async def initialize_db(pool):
    async with pool.acquire() as conn:
        try:
            await conn.execute("""
                CREATE TABLE IF NOT EXISTS chat_history (
                    id SERIAL PRIMARY KEY,
                    user_id BIGINT NOT NULL,
                    message TEXT NOT NULL,
                    is_user BOOLEAN NOT NULL,
                    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                );
            """)
            print("‚úÖ –¢–∞–±–ª–∏—Ü—è chat_history –≥–æ—Ç–æ–≤–∞!")
        except Exception as e:
            print(f"‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ: {e}")

# ‚úÖ –§—É–Ω–∫—Ü—ñ—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —É –±–∞–∑—É
async def save_message_to_db(pool, user_id, message, is_user=True):
    async with pool.acquire() as conn:
        try:
            await conn.execute(
                """
                INSERT INTO chat_history (user_id, message, is_user, timestamp)
                VALUES ($1, $2, $3, NOW());
                """,
                user_id, message, is_user
            )
            print(f"‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –ë–î: {message}")
        except Exception as e:
            print(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Å—É –≤ –ë–î: {e}")

# ‚úÖ –§—É–Ω–∫—Ü—ñ—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó —á–∞—Ç—É –∑ –∫–µ—à–µ–º –∞–±–æ –±–∞–∑–∏
async def get_chat_history_cached(context: ContextTypes.DEFAULT_TYPE, pool, user_id):
    if "chat_history" not in context.chat_data:
        context.chat_data["chat_history"] = {}

    if user_id in context.chat_data["chat_history"]:
        history_data = context.chat_data["chat_history"][user_id]
        if time.time() - history_data["timestamp"] < CACHE_EXPIRATION_TIME:
            return history_data["history"]

    # –Ø–∫—â–æ –∫–µ—à –∑–∞—Å—Ç–∞—Ä—ñ–≤ –∞–±–æ –π–æ–≥–æ –Ω–µ–º–∞—î ‚Äì –æ—Ç—Ä–∏–º—É—î–º–æ –ø–æ–≤–Ω—É —ñ—Å—Ç–æ—Ä—ñ—é –∑ PostgreSQL
    async with pool.acquire() as conn:
        try:
            rows = await conn.fetch("""
                SELECT message, is_user FROM chat_history
                WHERE user_id = $1
                ORDER BY timestamp ASC;
            """, user_id)
            context.chat_data["chat_history"][user_id] = {"history": rows, "timestamp": time.time()}
            return rows
        except Exception as e:
            print(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó —á–∞—Ç—É: {e}")
            return []

# ‚úÖ –§—É–Ω–∫—Ü—ñ—è –æ—á–∏—â–µ–Ω–Ω—è –∫–µ—à—É —â–æ–¥–Ω—è –æ 03:00 (GMT+3)
async def clear_old_cache(context: ContextTypes.DEFAULT_TYPE):
    if "chat_history" in context.chat_data:
        current_time = time.time()
        before_cleaning = len(context.chat_data["chat_history"])
        context.chat_data["chat_history"] = {
            user_id: data for user_id, data in context.chat_data["chat_history"].items()
            if current_time - data["timestamp"] < CACHE_EXPIRATION_TIME
        }
        after_cleaning = len(context.chat_data["chat_history"])
        print(f"‚úÖ –û—á–∏—â–µ–Ω–æ –∫–µ—à: {before_cleaning - after_cleaning} –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.")

# ‚úÖ –§—É–Ω–∫—Ü—ñ—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∫–µ—à—É
async def cache_status(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.from_user.id not in ADMINS:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ–º–∞—î –ø—Ä–∞–≤ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –∫–µ—à—É.")
        return

    if "chat_history" not in context.chat_data or not context.chat_data["chat_history"]:
        await update.message.reply_text("üìÇ –ö–µ—à –ø–æ—Ä–æ–∂–Ω—ñ–π –∞–±–æ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π.")
        return

    total_users = len(context.chat_data["chat_history"])
    await update.message.reply_text(f"üìä **–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —É –∫–µ—à—ñ:** {total_users}")

# ‚úÖ –§—É–Ω–∫—Ü—ñ—è –æ—á–∏—â–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó —á–∞—Ç—É
async def clear_history(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.from_user.id not in ADMINS:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ–º–∞—î –ø—Ä–∞–≤ –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó.")
        return

    user_id = update.message.chat_id
    pool = context.bot_data["db_pool"]

    if "chat_history" in context.chat_data:
        context.chat_data["chat_history"].pop(user_id, None)

    async with pool.acquire() as conn:
        try:
            await conn.execute("DELETE FROM chat_history WHERE user_id = $1;", user_id)
            await update.message.reply_text("‚úÖ –Ü—Å—Ç–æ—Ä—ñ—é —á–∞—Ç—É –æ—á–∏—â–µ–Ω–æ!")
            print(f"‚úÖ –Ü—Å—Ç–æ—Ä—ñ—è —á–∞—Ç—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {user_id} –±—É–ª–∞ –æ—á–∏—â–µ–Ω–∞.")
        except Exception as e:
            print(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ —ñ—Å—Ç–æ—Ä—ñ—ó: {e}")
            await update.message.reply_text("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—á–∏—â–µ–Ω–Ω—ñ —ñ—Å—Ç–æ—Ä—ñ—ó.")

# ‚úÖ –§—É–Ω–∫—Ü—ñ—è –æ–±—Ä–æ–±–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        user_message = update.message.text
        user_id = update.message.chat_id
        pool = context.bot_data["db_pool"]

        print(f"üü¢ –û—Ç—Ä–∏–º–∞–Ω–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ {user_id}: {user_message}")

        await save_message_to_db(pool, user_id, user_message, is_user=True)

        history = await get_chat_history_cached(context, pool, user_id)
        messages = [{"role": "system", "content": "–¢–∏ –î–æ—Ä–æ—Å–ª–∏–π —Ç–∞ –º—É–¥—Ä–∏–π —á–æ–ª–æ–≤—ñ–∫, —Ç–≤–æ—î —ñ–º º—è –î–∂–æ–Ω..."}]

        for record in history:
            role = "user" if record["is_user"] else "assistant"
            messages.append({"role": role, "content": record["message"]})

        messages.append({"role": "user", "content": user_message})

        response = await client.chat.completions.create(model="gpt-4o", messages=messages)
        bot_response_text = response.choices[0].message.content

        print(f"üü¢ –í—ñ–¥–ø–æ–≤—ñ–¥—å –±–æ—Ç–∞: {bot_response_text}")
        await update.message.reply_text(bot_response_text)

        await save_message_to_db(pool, user_id, bot_response_text, is_user=False)

    except Exception as e:
        print(f"‚ùå –ù–µ–æ—á—ñ–∫—É–≤–∞–Ω–∞ –ø–æ–º–∏–ª–∫–∞: {e}")

# ‚úÖ –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–¥–∞—á—ñ –∞–Ω–∫–µ—Ç–∏
async def send_survey(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("–ü–æ—á–∞—Ç–∏ –∞–Ω–∫–µ—Ç—É", callback_data='start_survey')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text('–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ü–æ—á–∞—Ç–∏ –∞–Ω–∫–µ—Ç—É" –¥–ª—è –ø–æ—á–∞—Ç–∫—É:', reply_markup=reply_markup)

# ‚úÖ –û–±—Ä–æ–±–∫–∞ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ "–ü–æ—á–∞—Ç–∏ –∞–Ω–∫–µ—Ç—É"
async def button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    await query.edit_message_text(text="–ê–Ω–∫–µ—Ç–∞ –ø–æ—á–∞–ª–∞—Å—è. –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π—Ç–µ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω—ñ –ø–∏—Ç–∞–Ω–Ω—è:")

    questions = [
        "–Ø–∫–µ –≤–∞—à–µ —ñ–º'—è?",
        "–°–∫—ñ–ª—å–∫–∏ –≤–∞–º —Ä–æ–∫—ñ–≤?",
        "–Ø–∫–∏–π –≤–∞—à email?",
        "–†–æ–∑–∫–∞–∂—ñ—Ç—å –ø—Ä–æ —Å–µ–±–µ"
    ]

    for question in questions:
        await context.bot.send_message(chat_id=query.message.chat_id, text=question)
        # –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –¥–ª—è –∑–±–æ—Ä—É –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π

# ‚úÖ –ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –∑–∞–ø—É—Å–∫—É –±–æ—Ç–∞
async def start_bot():
    db_pool = await connect_to_db()
    await initialize_db(db_pool)

    application = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
    application.bot_data["db_pool"] = db_pool
    application.add_handler(CommandHandler("cache_status", cache_status))
    application.add_handler(CommandHandler("clear_history", clear_history))
    application.add_handler(CommandHandler("survey", send_survey))  # –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∫–æ–º–∞–Ω–¥–∏ /survey
    application.add_handler(CallbackQueryHandler(button))  # –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    application.job_queue.run_daily(clear_old_cache, time=datetime.time(hour=3, tzinfo=TZ_KYIV))

    print("‚úÖ –ë–æ—Ç –ø—Ä–∞—Ü—é—î! –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å Stop, —â–æ–± –∑—É–ø–∏–Ω–∏—Ç–∏.")
    await application.run_polling()

if __name__ == "__main__":
    asyncio.run(start_bot())
